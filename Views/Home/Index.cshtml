@model IEnumerable<WebDoDungNhaBep.Models.SanPham>

<partial name="Bannerusers" />

@{
    ViewData["Title"] = "Danh sách sản phẩm";
}

<!-- Hiển thị thông báo kết quả tìm kiếm -->
@if (!string.IsNullOrEmpty(ViewBag.Keyword))
{
    <div class="alert alert-info mb-4">
        <h4 class="alert-heading">
            <i class="fa-solid fa-search me-2"></i>Kết quả tìm kiếm
        </h4>
        <p class="mb-0">Tìm thấy <strong class="text-primary">@Model.Count()</strong> sản phẩm cho từ khóa: "<strong>@ViewBag.Keyword</strong>"</p>
        <a asp-action="Index" class="btn btn-sm btn-outline-primary mt-2">Xem tất cả sản phẩm</a>
    </div>
}

<h2 class="mb-4 text-center text-primary fw-bold">
    @(ViewBag.Keyword != null ? $"Kết quả tìm kiếm cho: \"{ViewBag.Keyword}\"" : "Danh sách sản phẩm")
</h2>

<!-- Nếu không có sản phẩm nào -->
@if (Model == null || !Model.Any())
{
    <div class="text-center py-5">
        <i class="fa-solid fa-search fa-3x text-muted mb-3"></i>
        <h4 class="text-muted mb-3">
            @if (!string.IsNullOrEmpty(ViewBag.Keyword))
            {
                <text>Không tìm thấy sản phẩm phù hợp với từ khóa "<strong>@ViewBag.Keyword</strong>"</text>
            }
            else
            {
                <text>Không có sản phẩm nào</text>
            }
        </h4>
        @if (!string.IsNullOrEmpty(ViewBag.Keyword))
        {
            <a asp-action="Index" class="btn btn-primary">Xem tất cả sản phẩm</a>
        }
    </div>
}
else
{
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 row-cols-lg-5 g-4">
        @foreach (var sp in Model)
        {
            <div class="col">
                <div class="card h-100 shadow-sm border-0 product-card">
                    @{
                        string imgSrc;
                        if (!string.IsNullOrEmpty(sp.HinhAnh))
                        {
                            if (sp.HinhAnh.StartsWith("http", StringComparison.OrdinalIgnoreCase) ||
                            sp.HinhAnh.StartsWith("//"))
                            {
                                imgSrc = sp.HinhAnh;
                            }
                            else
                            {
                                imgSrc = Url.Content("~/" + sp.HinhAnh.TrimStart('/'));
                            }
                        }
                        else
                        {
                            imgSrc = Url.Content("~/img/no-image.png");
                        }
                    }

                    <img src="@imgSrc"
                         alt="@sp.TenSanPham"
                         class="card-img-top"
                         style="height:180px; object-fit:cover;"
                         onerror="this.src='@Url.Content("~/img/no-image.png")'" />

                    <div class="card-body d-flex flex-column">
                        <h6 class="card-title fw-bold text-truncate" title="@sp.TenSanPham">@sp.TenSanPham</h6>

                        <p class="card-text text-muted small flex-grow-1">
                            @if (!string.IsNullOrEmpty(sp.MoTa))
                            {
                                @(sp.MoTa.Length > 100 ? sp.MoTa.Substring(0, 100) + "..." : sp.MoTa)
                            }
                            else
                            {
                                <span class="text-muted fst-italic">Chưa có mô tả</span>
                            }
                        </p>

                        <p class="card-text text-success fw-bold mb-1">
                            @sp.Gia.ToString("N0") đ
                        </p>

                        <p class="card-text text-secondary small">
                            <i class="fa-solid fa-tag"></i>
                            @(sp.MaDanhMucNavigation?.TenDanhMuc ?? "Chưa phân loại")
                        </p>

                        <div class="mt-auto d-flex justify-content-between align-items-center">
                            <!-- Xem chi tiết -->
                            <a asp-action="ChiTiet" asp-controller="Home" asp-route-id="@sp.MaSanPham"
                               class="btn btn-sm btn-outline-primary" title="Xem chi tiết">
                                <i class="fa-solid fa-eye"></i>
                            </a>

                            <!-- Thêm vào giỏ -->
                            @if (Context.Session.GetInt32("MaAdmin") != null)
                            {
                                <form asp-action="ThemVaoGio" asp-controller="GioHang" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="maSanPham" value="@sp.MaSanPham" />
                                    <input type="hidden" name="soLuong" value="1" />
                                    <button type="submit" class="btn btn-sm btn-outline-warning" title="Thêm vào giỏ">
                                        <i class="fa-solid fa-cart-shopping"></i>
                                    </button>
                                </form>
                            }
                            else
                            {
                                <a asp-controller="Account" asp-action="Login"
                                   class="btn btn-sm btn-outline-warning" title="Đăng nhập để thêm vào giỏ">
                                    <i class="fa-solid fa-cart-shopping"></i>
                                </a>
                            }

                            <!-- Mua ngay -->
                            @if (Context.Session.GetInt32("MaAdmin") != null)
                            {
                                <form asp-action="MuaNgay" asp-controller="DonHang" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="maSanPham" value="@sp.MaSanPham" />
                                    <input type="hidden" name="soLuong" value="1" />
                                    <button type="submit" class="btn btn-sm btn-success" title="Mua ngay">
                                        <i class="fa-solid fa-credit-card"></i>
                                    </button>
                                </form>
                            }
                            else
                            {
                                <a asp-controller="Account" asp-action="Login"
                                   class="btn btn-sm btn-success" title="Đăng nhập để mua hàng">
                                    <i class="fa-solid fa-credit-card"></i>
                                </a>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}